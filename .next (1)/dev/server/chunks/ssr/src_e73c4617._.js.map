{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/damia/My%20Drive/Consultorias/All%20Boys/gestion-basket-app/src/lib/payment-actions.ts"],"sourcesContent":["'use server';\r\n\r\nimport { auth } from \"@/auth\";\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport { createAuditLog } from \"./actions\";\r\nimport * as XLSX from 'xlsx';\r\n\r\nexport type PaymentStatus = {\r\n    social: string;\r\n    activity: string;\r\n    socialDate?: string;\r\n    activityDate?: string;\r\n};\r\n\r\nexport type PlayerMatchResult = {\r\n    originalData: any;\r\n    status: 'MATCHED' | 'UNMATCHED';\r\n    matchMethod?: 'DNI' | 'PARTNER_NUMBER' | 'NAME_FUZZY';\r\n    player?: {\r\n        id: string;\r\n        name: string;\r\n        dni: string;\r\n        category: string;\r\n        tira: string;\r\n    };\r\n    paymentStatus?: PaymentStatus;\r\n    notes?: string[];\r\n};\r\n\r\nexport type ImportResult = {\r\n    success: boolean;\r\n    message?: string;\r\n    stats: {\r\n        total: number;\r\n        matched: number;\r\n        unmatched: number;\r\n    };\r\n    results: PlayerMatchResult[];\r\n    logs: string[];\r\n};\r\n\r\nexport type FederationPaymentData = {\r\n    year: number;\r\n    installments: string;\r\n};\r\n\r\nexport type FederationMatchResult = {\r\n    originalData: any;\r\n    status: 'MATCHED' | 'UNMATCHED';\r\n    matchMethod?: 'DNI' | 'NAME_FUZZY';\r\n    player?: {\r\n        id: string;\r\n        name: string;\r\n        dni: string;\r\n        category: string;\r\n        tira: string;\r\n        playerStatus: string;\r\n    };\r\n    federationData?: FederationPaymentData;\r\n    notes?: string[];\r\n};\r\n\r\nexport type FederationImportResult = {\r\n    success: boolean;\r\n    message?: string;\r\n    stats: {\r\n        total: number;\r\n        matched: number;\r\n        unmatched: number;\r\n    };\r\n    results: FederationMatchResult[];\r\n    logs: string[];\r\n};\r\n\r\nfunction normalizeString(str: string): string {\r\n    return str ? str.trim().toUpperCase().normalize(\"NFD\").replace(/[\\u0300-\\u036f]/g, \"\") : \"\";\r\n}\r\n\r\n/**\r\n * Finds a column key in a row using flexible matching:\r\n * - Exact match (case-insensitive, normalized whitespace)\r\n * - Partial match (key contains the candidate)\r\n */\r\nfunction findColumn(row: any, candidates: string[]): string | undefined {\r\n    const rowKeys = Object.keys(row);\r\n    // Pass 1: exact match after normalizing whitespace\r\n    for (const candidate of candidates) {\r\n        const nc = candidate.trim().toLowerCase().replace(/\\s+/g, ' ');\r\n        const found = rowKeys.find(k => k.trim().toLowerCase().replace(/[\\r\\n\\s]+/g, ' ') === nc);\r\n        if (found) return found;\r\n    }\r\n    // Pass 2: partial includes\r\n    for (const candidate of candidates) {\r\n        const nc = candidate.trim().toLowerCase();\r\n        const found = rowKeys.find(k => k.toLowerCase().replace(/[\\r\\n]+/g, ' ').trim().includes(nc));\r\n        if (found) return found;\r\n    }\r\n    return undefined;\r\n}\r\n\r\n// â”€â”€â”€ CUOTA SOCIAL / ACTIVIDAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n\r\nexport async function processPaymentExcel(prevState: any, formData: FormData): Promise<ImportResult> {\r\n    const session = await auth();\r\n    if (!session) {\r\n        return { success: false, message: \"No autorizado\", stats: { total: 0, matched: 0, unmatched: 0 }, results: [], logs: [\"Error: Usuario no autenticado\"] };\r\n    }\r\n\r\n    const file = formData.get('file') as File;\r\n    if (!file) {\r\n        return { success: false, message: \"No se seleccionÃ³ archivo\", stats: { total: 0, matched: 0, unmatched: 0 }, results: [], logs: [\"Error: Sin archivo\"] };\r\n    }\r\n\r\n    const logs: string[] = [];\r\n    logs.push(`Inicio de procesamiento: ${new Date().toLocaleString()}`);\r\n\r\n    try {\r\n        const arrayBuffer = await file.arrayBuffer();\r\n        const buffer = Buffer.from(arrayBuffer);\r\n        const workbook = XLSX.read(buffer, { type: 'buffer' });\r\n\r\n        const sheetName = workbook.SheetNames.find(s => s.toLowerCase().includes('basquet')) || workbook.SheetNames[0];\r\n        logs.push(`Leyendo hoja: ${sheetName}`);\r\n\r\n        const sheet = workbook.Sheets[sheetName];\r\n        const rawData = XLSX.utils.sheet_to_json(sheet);\r\n        logs.push(`Filas encontradas: ${rawData.length}`);\r\n\r\n        if (rawData.length > 0) {\r\n            logs.push(`Columnas detectadas: ${Object.keys(rawData[0] as any).join(' | ')}`);\r\n        }\r\n\r\n        // Fetch ACTIVO + REVISAR players\r\n        const dbPlayers = await (prisma.player as any).findMany({\r\n            where: { status: { in: ['ACTIVO', 'REVISAR'] } },\r\n            select: { id: true, firstName: true, lastName: true, dni: true, partnerNumber: true, tira: true, category: true }\r\n        });\r\n        logs.push(`Jugadores (ACTIVO + REVISAR) en DB: ${dbPlayers.length}`);\r\n\r\n        const results: PlayerMatchResult[] = [];\r\n        let matchedCount = 0;\r\n\r\n        for (const [index, row] of rawData.entries()) {\r\n            const r = row as any;\r\n            const rowNum = index + 2;\r\n            const notes: string[] = [];\r\n\r\n            // Flexible column detection - handles: documento, DNI\r\n            const dniKey = findColumn(r, ['documento', 'dni']);\r\n            // nrosocio (sin espacio), nro. socio, nro socio\r\n            const socioKey = findColumn(r, ['nrosocio', 'nro. socio', 'nro socio', 'socio']);\r\n            const apellidoKey = findColumn(r, ['apellido']);\r\n            const nombreKey = findColumn(r, ['nombre']);\r\n            // \"Ultima cuota social abonada\" / \"Ultoma cuota Social Abonada\"\r\n            const socialKey = findColumn(r, ['ultima cuota social abonada', 'ultima cuota social', 'cuota social']);\r\n            const activityKey = findColumn(r, ['ultima cuota actividad abonada', 'ultima cuota actividad', 'cuota actividad']);\r\n\r\n            const dni = dniKey ? r[dniKey]?.toString().trim() : undefined;\r\n            const socio = socioKey ? r[socioKey]?.toString().trim() : undefined;\r\n            const apellido = apellidoKey ? normalizeString(r[apellidoKey]?.toString()) : '';\r\n            const nombre = nombreKey ? normalizeString(r[nombreKey]?.toString()) : '';\r\n            const lastSocial = socialKey ? r[socialKey]?.toString().trim() : undefined;\r\n            const lastActivity = activityKey ? r[activityKey]?.toString().trim() : undefined;\r\n\r\n            let match: typeof dbPlayers[0] | undefined;\r\n            let method: 'DNI' | 'PARTNER_NUMBER' | 'NAME_FUZZY' | undefined;\r\n\r\n            // 1. Try DNI / Documento\r\n            if (dni && dni.length > 4) {\r\n                match = dbPlayers.find((p: any) => p.dni === dni);\r\n                if (match) method = 'DNI';\r\n            }\r\n\r\n            // 2. Try Nro. Socio\r\n            if (!match && socio) {\r\n                match = dbPlayers.find((p: any) => p.partnerNumber === socio);\r\n                if (match) method = 'PARTNER_NUMBER';\r\n            }\r\n\r\n            // 3. Try Name Fuzzy (exact clean match)\r\n            if (!match && nombre && apellido) {\r\n                match = dbPlayers.find((p: any) =>\r\n                    normalizeString(p.firstName) === nombre &&\r\n                    normalizeString(p.lastName) === apellido\r\n                );\r\n                if (match) method = 'NAME_FUZZY';\r\n            }\r\n\r\n            const paymentStatus: PaymentStatus = {\r\n                social: lastSocial || '-',\r\n                activity: lastActivity || '-',\r\n                socialDate: lastSocial,\r\n                activityDate: lastActivity\r\n            };\r\n\r\n            if (match) {\r\n                matchedCount++;\r\n                logs.push(`Fila ${rowNum}: Encontrado ${match.firstName} ${match.lastName} por ${method}`);\r\n                results.push({\r\n                    status: 'MATCHED',\r\n                    matchMethod: method,\r\n                    originalData: row,\r\n                    player: {\r\n                        id: match.id,\r\n                        name: `${match.lastName}, ${match.firstName}`,\r\n                        dni: match.dni,\r\n                        category: match.category || 'N/A',\r\n                        tira: match.tira\r\n                    },\r\n                    paymentStatus,\r\n                    notes\r\n                });\r\n            } else {\r\n                notes.push(`No se pudo encontrar jugador: ${apellido}, ${nombre} (DNI: ${dni})`);\r\n                results.push({\r\n                    status: 'UNMATCHED',\r\n                    originalData: row,\r\n                    paymentStatus,\r\n                    notes\r\n                });\r\n            }\r\n        }\r\n\r\n        logs.push(`Proceso de ANÃLISIS finalizado. Coincidencias: ${matchedCount}/${rawData.length}`);\r\n        logs.push(`NOTA: No se han guardado cambios en la base de datos. Revise y confirme.`);\r\n\r\n        return {\r\n            success: true,\r\n            stats: { total: rawData.length, matched: matchedCount, unmatched: rawData.length - matchedCount },\r\n            results,\r\n            logs\r\n        };\r\n\r\n    } catch (e: any) {\r\n        logs.push(`ERROR CRÃTICO: ${e.message}`);\r\n        return { success: false, message: e.message, stats: { total: 0, matched: 0, unmatched: 0 }, results: [], logs };\r\n    }\r\n}\r\n\r\nexport async function savePaymentUpdates(prevState: any, dataset: PlayerMatchResult[]) {\r\n    const session = await auth();\r\n    if (!session) return { success: false, message: \"No autorizado\" };\r\n\r\n    const updates = dataset.filter(d => d.status === 'MATCHED' && d.player?.id);\r\n    let count = 0;\r\n\r\n    try {\r\n        for (const item of updates) {\r\n            if (!item.player?.id) continue;\r\n            await (prisma.player as any).update({\r\n                where: { id: item.player.id },\r\n                data: {\r\n                    lastSocialPayment: item.paymentStatus?.social,\r\n                    lastActivityPayment: item.paymentStatus?.activity\r\n                }\r\n            });\r\n            count++;\r\n        }\r\n        await createAuditLog('IMPORT_PAYMENTS', 'Player', 'BATCH', { count, total: updates.length });\r\n        return { success: true, message: `Se actualizaron los pagos de ${count} jugadores correctamente.` };\r\n    } catch (error: any) {\r\n        return { success: false, message: \"Error al guardar: \" + error.message };\r\n    }\r\n}\r\n\r\n// â”€â”€â”€ SEGURO / FEDERACIÃ“N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n\r\nexport async function processFederationPaymentExcel(prevState: any, formData: FormData): Promise<FederationImportResult> {\r\n    const session = await auth();\r\n    if (!session) {\r\n        return { success: false, message: \"No autorizado\", stats: { total: 0, matched: 0, unmatched: 0 }, results: [], logs: [\"Error: Usuario no autenticado\"] };\r\n    }\r\n\r\n    const file = formData.get('file') as File;\r\n    if (!file) {\r\n        return { success: false, message: \"No se seleccionÃ³ archivo\", stats: { total: 0, matched: 0, unmatched: 0 }, results: [], logs: [\"Error: Sin archivo\"] };\r\n    }\r\n\r\n    const logs: string[] = [];\r\n    logs.push(`Inicio de procesamiento: ${new Date().toLocaleString()}`);\r\n\r\n    try {\r\n        const arrayBuffer = await file.arrayBuffer();\r\n        const buffer = Buffer.from(arrayBuffer);\r\n        const workbook = XLSX.read(buffer, { type: 'buffer' });\r\n\r\n        const sheetName = workbook.SheetNames[0];\r\n        logs.push(`Leyendo hoja: ${sheetName}`);\r\n\r\n        const sheet = workbook.Sheets[sheetName];\r\n        const rawData = XLSX.utils.sheet_to_json(sheet);\r\n        logs.push(`Filas encontradas: ${rawData.length}`);\r\n\r\n        if (rawData.length > 0) {\r\n            logs.push(`Columnas detectadas: ${Object.keys(rawData[0] as any).join(' | ')}`);\r\n        }\r\n\r\n        // Fetch ACTIVO + REVISAR players\r\n        const dbPlayers = await (prisma.player as any).findMany({\r\n            where: { status: { in: ['ACTIVO', 'REVISAR'] } },\r\n            select: { id: true, firstName: true, lastName: true, dni: true, tira: true, category: true, status: true }\r\n        });\r\n        logs.push(`Jugadores (ACTIVO + REVISAR) en DB: ${dbPlayers.length}`);\r\n\r\n        const results: FederationMatchResult[] = [];\r\n        let matchedCount = 0;\r\n\r\n        for (const [index, row] of rawData.entries()) {\r\n            const r = row as any;\r\n            const rowNum = index + 2;\r\n            const notes: string[] = [];\r\n\r\n            const dniKey = findColumn(r, ['dni', 'documento']);\r\n            const apellidoKey = findColumn(r, ['apellido']);\r\n            const nombreKey = findColumn(r, ['nombre']);\r\n            const yearKey = findColumn(r, ['aÃ±o', 'anio', 'year', 'aÃ±o pago', 'aÃ±o del pago']);\r\n            const cuotasKey = findColumn(r, ['cuotas', 'cuotas abonadas', 'cuotas pagadas', 'installments', 'estado']);\r\n\r\n            const dni = dniKey ? r[dniKey]?.toString().trim() : undefined;\r\n            const apellido = apellidoKey ? normalizeString(r[apellidoKey]?.toString()) : '';\r\n            const nombre = nombreKey ? normalizeString(r[nombreKey]?.toString()) : '';\r\n            const yearRaw = yearKey ? r[yearKey]?.toString().trim() : undefined;\r\n            const cuotasRaw = cuotasKey ? r[cuotasKey]?.toString().trim().toUpperCase() : undefined;\r\n\r\n            const year = yearRaw ? parseInt(yearRaw) : NaN;\r\n            const installments = cuotasRaw || '';\r\n\r\n            let match: typeof dbPlayers[0] | undefined;\r\n            let method: 'DNI' | 'NAME_FUZZY' | undefined;\r\n\r\n            if (dni && dni.length > 4) {\r\n                match = dbPlayers.find((p: any) => p.dni === dni);\r\n                if (match) method = 'DNI';\r\n            }\r\n\r\n            if (!match && nombre && apellido) {\r\n                match = dbPlayers.find((p: any) =>\r\n                    normalizeString(p.firstName) === nombre &&\r\n                    normalizeString(p.lastName) === apellido\r\n                );\r\n                if (match) method = 'NAME_FUZZY';\r\n            }\r\n\r\n            const federationData: FederationPaymentData | undefined =\r\n                (!isNaN(year) && installments) ? { year, installments } : undefined;\r\n\r\n            if (!federationData) {\r\n                notes.push(`Fila ${rowNum}: AÃ±o o cuotas invÃ¡lidos o faltantes.`);\r\n            }\r\n\r\n            if (match) {\r\n                matchedCount++;\r\n                logs.push(`Fila ${rowNum}: Encontrado ${match.firstName} ${match.lastName} (${match.status}) por ${method}`);\r\n                results.push({\r\n                    status: 'MATCHED',\r\n                    matchMethod: method,\r\n                    originalData: row,\r\n                    player: {\r\n                        id: match.id,\r\n                        name: `${match.lastName}, ${match.firstName}`,\r\n                        dni: match.dni,\r\n                        category: match.category || 'N/A',\r\n                        tira: match.tira,\r\n                        playerStatus: match.status\r\n                    },\r\n                    federationData,\r\n                    notes\r\n                });\r\n            } else {\r\n                notes.push(`No se pudo encontrar jugador: ${apellido}, ${nombre} (DNI: ${dni})`);\r\n                results.push({ status: 'UNMATCHED', originalData: row, federationData, notes });\r\n            }\r\n        }\r\n\r\n        logs.push(`Proceso de ANÃLISIS finalizado. Coincidencias: ${matchedCount}/${rawData.length}`);\r\n        logs.push(`NOTA: No se han guardado cambios en la base de datos. Revise y confirme.`);\r\n\r\n        return {\r\n            success: true,\r\n            stats: { total: rawData.length, matched: matchedCount, unmatched: rawData.length - matchedCount },\r\n            results,\r\n            logs\r\n        };\r\n\r\n    } catch (e: any) {\r\n        logs.push(`ERROR CRÃTICO: ${e.message}`);\r\n        return { success: false, message: e.message, stats: { total: 0, matched: 0, unmatched: 0 }, results: [], logs };\r\n    }\r\n}\r\n\r\nexport async function saveFederationPaymentUpdates(prevState: any, dataset: FederationMatchResult[]) {\r\n    const session = await auth();\r\n    if (!session) return { success: false, message: \"No autorizado\" };\r\n\r\n    const updates = dataset.filter(d => d.status === 'MATCHED' && d.player?.id && d.federationData);\r\n    let count = 0;\r\n\r\n    try {\r\n        for (const item of updates) {\r\n            if (!item.player?.id || !item.federationData) continue;\r\n            await (prisma.player as any).update({\r\n                where: { id: item.player.id },\r\n                data: {\r\n                    federationYear: item.federationData.year,\r\n                    federationInstallments: item.federationData.installments\r\n                }\r\n            });\r\n            count++;\r\n        }\r\n        await createAuditLog('IMPORT_FEDERATION_PAYMENTS', 'Player', 'BATCH', { count, total: updates.length });\r\n        return { success: true, message: `Se actualizÃ³ el pago de federaciÃ³n/seguro de ${count} jugadores correctamente.` };\r\n    } catch (error: any) {\r\n        return { success: false, message: \"Error al guardar: \" + error.message };\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;;MAsGsB,wBAAA,WAAA,GAAA,IAAA,+OAAA,EAAA,8CAAA,oOAAA,EAAA,KAAA,GAAA,0OAAA,EAAA,uDAAA"}},
    {"offset": {"line": 18, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/damia/My%20Drive/Consultorias/All%20Boys/gestion-basket-app/src/lib/payment-actions.ts"],"sourcesContent":["'use server';\r\n\r\nimport { auth } from \"@/auth\";\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport { createAuditLog } from \"./actions\";\r\nimport * as XLSX from 'xlsx';\r\n\r\nexport type PaymentStatus = {\r\n    social: string;\r\n    activity: string;\r\n    socialDate?: string;\r\n    activityDate?: string;\r\n};\r\n\r\nexport type PlayerMatchResult = {\r\n    originalData: any;\r\n    status: 'MATCHED' | 'UNMATCHED';\r\n    matchMethod?: 'DNI' | 'PARTNER_NUMBER' | 'NAME_FUZZY';\r\n    player?: {\r\n        id: string;\r\n        name: string;\r\n        dni: string;\r\n        category: string;\r\n        tira: string;\r\n    };\r\n    paymentStatus?: PaymentStatus;\r\n    notes?: string[];\r\n};\r\n\r\nexport type ImportResult = {\r\n    success: boolean;\r\n    message?: string;\r\n    stats: {\r\n        total: number;\r\n        matched: number;\r\n        unmatched: number;\r\n    };\r\n    results: PlayerMatchResult[];\r\n    logs: string[];\r\n};\r\n\r\nexport type FederationPaymentData = {\r\n    year: number;\r\n    installments: string;\r\n};\r\n\r\nexport type FederationMatchResult = {\r\n    originalData: any;\r\n    status: 'MATCHED' | 'UNMATCHED';\r\n    matchMethod?: 'DNI' | 'NAME_FUZZY';\r\n    player?: {\r\n        id: string;\r\n        name: string;\r\n        dni: string;\r\n        category: string;\r\n        tira: string;\r\n        playerStatus: string;\r\n    };\r\n    federationData?: FederationPaymentData;\r\n    notes?: string[];\r\n};\r\n\r\nexport type FederationImportResult = {\r\n    success: boolean;\r\n    message?: string;\r\n    stats: {\r\n        total: number;\r\n        matched: number;\r\n        unmatched: number;\r\n    };\r\n    results: FederationMatchResult[];\r\n    logs: string[];\r\n};\r\n\r\nfunction normalizeString(str: string): string {\r\n    return str ? str.trim().toUpperCase().normalize(\"NFD\").replace(/[\\u0300-\\u036f]/g, \"\") : \"\";\r\n}\r\n\r\n/**\r\n * Finds a column key in a row using flexible matching:\r\n * - Exact match (case-insensitive, normalized whitespace)\r\n * - Partial match (key contains the candidate)\r\n */\r\nfunction findColumn(row: any, candidates: string[]): string | undefined {\r\n    const rowKeys = Object.keys(row);\r\n    // Pass 1: exact match after normalizing whitespace\r\n    for (const candidate of candidates) {\r\n        const nc = candidate.trim().toLowerCase().replace(/\\s+/g, ' ');\r\n        const found = rowKeys.find(k => k.trim().toLowerCase().replace(/[\\r\\n\\s]+/g, ' ') === nc);\r\n        if (found) return found;\r\n    }\r\n    // Pass 2: partial includes\r\n    for (const candidate of candidates) {\r\n        const nc = candidate.trim().toLowerCase();\r\n        const found = rowKeys.find(k => k.toLowerCase().replace(/[\\r\\n]+/g, ' ').trim().includes(nc));\r\n        if (found) return found;\r\n    }\r\n    return undefined;\r\n}\r\n\r\n// â”€â”€â”€ CUOTA SOCIAL / ACTIVIDAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n\r\nexport async function processPaymentExcel(prevState: any, formData: FormData): Promise<ImportResult> {\r\n    const session = await auth();\r\n    if (!session) {\r\n        return { success: false, message: \"No autorizado\", stats: { total: 0, matched: 0, unmatched: 0 }, results: [], logs: [\"Error: Usuario no autenticado\"] };\r\n    }\r\n\r\n    const file = formData.get('file') as File;\r\n    if (!file) {\r\n        return { success: false, message: \"No se seleccionÃ³ archivo\", stats: { total: 0, matched: 0, unmatched: 0 }, results: [], logs: [\"Error: Sin archivo\"] };\r\n    }\r\n\r\n    const logs: string[] = [];\r\n    logs.push(`Inicio de procesamiento: ${new Date().toLocaleString()}`);\r\n\r\n    try {\r\n        const arrayBuffer = await file.arrayBuffer();\r\n        const buffer = Buffer.from(arrayBuffer);\r\n        const workbook = XLSX.read(buffer, { type: 'buffer' });\r\n\r\n        const sheetName = workbook.SheetNames.find(s => s.toLowerCase().includes('basquet')) || workbook.SheetNames[0];\r\n        logs.push(`Leyendo hoja: ${sheetName}`);\r\n\r\n        const sheet = workbook.Sheets[sheetName];\r\n        const rawData = XLSX.utils.sheet_to_json(sheet);\r\n        logs.push(`Filas encontradas: ${rawData.length}`);\r\n\r\n        if (rawData.length > 0) {\r\n            logs.push(`Columnas detectadas: ${Object.keys(rawData[0] as any).join(' | ')}`);\r\n        }\r\n\r\n        // Fetch ACTIVO + REVISAR players\r\n        const dbPlayers = await (prisma.player as any).findMany({\r\n            where: { status: { in: ['ACTIVO', 'REVISAR'] } },\r\n            select: { id: true, firstName: true, lastName: true, dni: true, partnerNumber: true, tira: true, category: true }\r\n        });\r\n        logs.push(`Jugadores (ACTIVO + REVISAR) en DB: ${dbPlayers.length}`);\r\n\r\n        const results: PlayerMatchResult[] = [];\r\n        let matchedCount = 0;\r\n\r\n        for (const [index, row] of rawData.entries()) {\r\n            const r = row as any;\r\n            const rowNum = index + 2;\r\n            const notes: string[] = [];\r\n\r\n            // Flexible column detection - handles: documento, DNI\r\n            const dniKey = findColumn(r, ['documento', 'dni']);\r\n            // nrosocio (sin espacio), nro. socio, nro socio\r\n            const socioKey = findColumn(r, ['nrosocio', 'nro. socio', 'nro socio', 'socio']);\r\n            const apellidoKey = findColumn(r, ['apellido']);\r\n            const nombreKey = findColumn(r, ['nombre']);\r\n            // \"Ultima cuota social abonada\" / \"Ultoma cuota Social Abonada\"\r\n            const socialKey = findColumn(r, ['ultima cuota social abonada', 'ultima cuota social', 'cuota social']);\r\n            const activityKey = findColumn(r, ['ultima cuota actividad abonada', 'ultima cuota actividad', 'cuota actividad']);\r\n\r\n            const dni = dniKey ? r[dniKey]?.toString().trim() : undefined;\r\n            const socio = socioKey ? r[socioKey]?.toString().trim() : undefined;\r\n            const apellido = apellidoKey ? normalizeString(r[apellidoKey]?.toString()) : '';\r\n            const nombre = nombreKey ? normalizeString(r[nombreKey]?.toString()) : '';\r\n            const lastSocial = socialKey ? r[socialKey]?.toString().trim() : undefined;\r\n            const lastActivity = activityKey ? r[activityKey]?.toString().trim() : undefined;\r\n\r\n            let match: typeof dbPlayers[0] | undefined;\r\n            let method: 'DNI' | 'PARTNER_NUMBER' | 'NAME_FUZZY' | undefined;\r\n\r\n            // 1. Try DNI / Documento\r\n            if (dni && dni.length > 4) {\r\n                match = dbPlayers.find((p: any) => p.dni === dni);\r\n                if (match) method = 'DNI';\r\n            }\r\n\r\n            // 2. Try Nro. Socio\r\n            if (!match && socio) {\r\n                match = dbPlayers.find((p: any) => p.partnerNumber === socio);\r\n                if (match) method = 'PARTNER_NUMBER';\r\n            }\r\n\r\n            // 3. Try Name Fuzzy (exact clean match)\r\n            if (!match && nombre && apellido) {\r\n                match = dbPlayers.find((p: any) =>\r\n                    normalizeString(p.firstName) === nombre &&\r\n                    normalizeString(p.lastName) === apellido\r\n                );\r\n                if (match) method = 'NAME_FUZZY';\r\n            }\r\n\r\n            const paymentStatus: PaymentStatus = {\r\n                social: lastSocial || '-',\r\n                activity: lastActivity || '-',\r\n                socialDate: lastSocial,\r\n                activityDate: lastActivity\r\n            };\r\n\r\n            if (match) {\r\n                matchedCount++;\r\n                logs.push(`Fila ${rowNum}: Encontrado ${match.firstName} ${match.lastName} por ${method}`);\r\n                results.push({\r\n                    status: 'MATCHED',\r\n                    matchMethod: method,\r\n                    originalData: row,\r\n                    player: {\r\n                        id: match.id,\r\n                        name: `${match.lastName}, ${match.firstName}`,\r\n                        dni: match.dni,\r\n                        category: match.category || 'N/A',\r\n                        tira: match.tira\r\n                    },\r\n                    paymentStatus,\r\n                    notes\r\n                });\r\n            } else {\r\n                notes.push(`No se pudo encontrar jugador: ${apellido}, ${nombre} (DNI: ${dni})`);\r\n                results.push({\r\n                    status: 'UNMATCHED',\r\n                    originalData: row,\r\n                    paymentStatus,\r\n                    notes\r\n                });\r\n            }\r\n        }\r\n\r\n        logs.push(`Proceso de ANÃLISIS finalizado. Coincidencias: ${matchedCount}/${rawData.length}`);\r\n        logs.push(`NOTA: No se han guardado cambios en la base de datos. Revise y confirme.`);\r\n\r\n        return {\r\n            success: true,\r\n            stats: { total: rawData.length, matched: matchedCount, unmatched: rawData.length - matchedCount },\r\n            results,\r\n            logs\r\n        };\r\n\r\n    } catch (e: any) {\r\n        logs.push(`ERROR CRÃTICO: ${e.message}`);\r\n        return { success: false, message: e.message, stats: { total: 0, matched: 0, unmatched: 0 }, results: [], logs };\r\n    }\r\n}\r\n\r\nexport async function savePaymentUpdates(prevState: any, dataset: PlayerMatchResult[]) {\r\n    const session = await auth();\r\n    if (!session) return { success: false, message: \"No autorizado\" };\r\n\r\n    const updates = dataset.filter(d => d.status === 'MATCHED' && d.player?.id);\r\n    let count = 0;\r\n\r\n    try {\r\n        for (const item of updates) {\r\n            if (!item.player?.id) continue;\r\n            await (prisma.player as any).update({\r\n                where: { id: item.player.id },\r\n                data: {\r\n                    lastSocialPayment: item.paymentStatus?.social,\r\n                    lastActivityPayment: item.paymentStatus?.activity\r\n                }\r\n            });\r\n            count++;\r\n        }\r\n        await createAuditLog('IMPORT_PAYMENTS', 'Player', 'BATCH', { count, total: updates.length });\r\n        return { success: true, message: `Se actualizaron los pagos de ${count} jugadores correctamente.` };\r\n    } catch (error: any) {\r\n        return { success: false, message: \"Error al guardar: \" + error.message };\r\n    }\r\n}\r\n\r\n// â”€â”€â”€ SEGURO / FEDERACIÃ“N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n\r\nexport async function processFederationPaymentExcel(prevState: any, formData: FormData): Promise<FederationImportResult> {\r\n    const session = await auth();\r\n    if (!session) {\r\n        return { success: false, message: \"No autorizado\", stats: { total: 0, matched: 0, unmatched: 0 }, results: [], logs: [\"Error: Usuario no autenticado\"] };\r\n    }\r\n\r\n    const file = formData.get('file') as File;\r\n    if (!file) {\r\n        return { success: false, message: \"No se seleccionÃ³ archivo\", stats: { total: 0, matched: 0, unmatched: 0 }, results: [], logs: [\"Error: Sin archivo\"] };\r\n    }\r\n\r\n    const logs: string[] = [];\r\n    logs.push(`Inicio de procesamiento: ${new Date().toLocaleString()}`);\r\n\r\n    try {\r\n        const arrayBuffer = await file.arrayBuffer();\r\n        const buffer = Buffer.from(arrayBuffer);\r\n        const workbook = XLSX.read(buffer, { type: 'buffer' });\r\n\r\n        const sheetName = workbook.SheetNames[0];\r\n        logs.push(`Leyendo hoja: ${sheetName}`);\r\n\r\n        const sheet = workbook.Sheets[sheetName];\r\n        const rawData = XLSX.utils.sheet_to_json(sheet);\r\n        logs.push(`Filas encontradas: ${rawData.length}`);\r\n\r\n        if (rawData.length > 0) {\r\n            logs.push(`Columnas detectadas: ${Object.keys(rawData[0] as any).join(' | ')}`);\r\n        }\r\n\r\n        // Fetch ACTIVO + REVISAR players\r\n        const dbPlayers = await (prisma.player as any).findMany({\r\n            where: { status: { in: ['ACTIVO', 'REVISAR'] } },\r\n            select: { id: true, firstName: true, lastName: true, dni: true, tira: true, category: true, status: true }\r\n        });\r\n        logs.push(`Jugadores (ACTIVO + REVISAR) en DB: ${dbPlayers.length}`);\r\n\r\n        const results: FederationMatchResult[] = [];\r\n        let matchedCount = 0;\r\n\r\n        for (const [index, row] of rawData.entries()) {\r\n            const r = row as any;\r\n            const rowNum = index + 2;\r\n            const notes: string[] = [];\r\n\r\n            const dniKey = findColumn(r, ['dni', 'documento']);\r\n            const apellidoKey = findColumn(r, ['apellido']);\r\n            const nombreKey = findColumn(r, ['nombre']);\r\n            const yearKey = findColumn(r, ['aÃ±o', 'anio', 'year', 'aÃ±o pago', 'aÃ±o del pago']);\r\n            const cuotasKey = findColumn(r, ['cuotas', 'cuotas abonadas', 'cuotas pagadas', 'installments', 'estado']);\r\n\r\n            const dni = dniKey ? r[dniKey]?.toString().trim() : undefined;\r\n            const apellido = apellidoKey ? normalizeString(r[apellidoKey]?.toString()) : '';\r\n            const nombre = nombreKey ? normalizeString(r[nombreKey]?.toString()) : '';\r\n            const yearRaw = yearKey ? r[yearKey]?.toString().trim() : undefined;\r\n            const cuotasRaw = cuotasKey ? r[cuotasKey]?.toString().trim().toUpperCase() : undefined;\r\n\r\n            const year = yearRaw ? parseInt(yearRaw) : NaN;\r\n            const installments = cuotasRaw || '';\r\n\r\n            let match: typeof dbPlayers[0] | undefined;\r\n            let method: 'DNI' | 'NAME_FUZZY' | undefined;\r\n\r\n            if (dni && dni.length > 4) {\r\n                match = dbPlayers.find((p: any) => p.dni === dni);\r\n                if (match) method = 'DNI';\r\n            }\r\n\r\n            if (!match && nombre && apellido) {\r\n                match = dbPlayers.find((p: any) =>\r\n                    normalizeString(p.firstName) === nombre &&\r\n                    normalizeString(p.lastName) === apellido\r\n                );\r\n                if (match) method = 'NAME_FUZZY';\r\n            }\r\n\r\n            const federationData: FederationPaymentData | undefined =\r\n                (!isNaN(year) && installments) ? { year, installments } : undefined;\r\n\r\n            if (!federationData) {\r\n                notes.push(`Fila ${rowNum}: AÃ±o o cuotas invÃ¡lidos o faltantes.`);\r\n            }\r\n\r\n            if (match) {\r\n                matchedCount++;\r\n                logs.push(`Fila ${rowNum}: Encontrado ${match.firstName} ${match.lastName} (${match.status}) por ${method}`);\r\n                results.push({\r\n                    status: 'MATCHED',\r\n                    matchMethod: method,\r\n                    originalData: row,\r\n                    player: {\r\n                        id: match.id,\r\n                        name: `${match.lastName}, ${match.firstName}`,\r\n                        dni: match.dni,\r\n                        category: match.category || 'N/A',\r\n                        tira: match.tira,\r\n                        playerStatus: match.status\r\n                    },\r\n                    federationData,\r\n                    notes\r\n                });\r\n            } else {\r\n                notes.push(`No se pudo encontrar jugador: ${apellido}, ${nombre} (DNI: ${dni})`);\r\n                results.push({ status: 'UNMATCHED', originalData: row, federationData, notes });\r\n            }\r\n        }\r\n\r\n        logs.push(`Proceso de ANÃLISIS finalizado. Coincidencias: ${matchedCount}/${rawData.length}`);\r\n        logs.push(`NOTA: No se han guardado cambios en la base de datos. Revise y confirme.`);\r\n\r\n        return {\r\n            success: true,\r\n            stats: { total: rawData.length, matched: matchedCount, unmatched: rawData.length - matchedCount },\r\n            results,\r\n            logs\r\n        };\r\n\r\n    } catch (e: any) {\r\n        logs.push(`ERROR CRÃTICO: ${e.message}`);\r\n        return { success: false, message: e.message, stats: { total: 0, matched: 0, unmatched: 0 }, results: [], logs };\r\n    }\r\n}\r\n\r\nexport async function saveFederationPaymentUpdates(prevState: any, dataset: FederationMatchResult[]) {\r\n    const session = await auth();\r\n    if (!session) return { success: false, message: \"No autorizado\" };\r\n\r\n    const updates = dataset.filter(d => d.status === 'MATCHED' && d.player?.id && d.federationData);\r\n    let count = 0;\r\n\r\n    try {\r\n        for (const item of updates) {\r\n            if (!item.player?.id || !item.federationData) continue;\r\n            await (prisma.player as any).update({\r\n                where: { id: item.player.id },\r\n                data: {\r\n                    federationYear: item.federationData.year,\r\n                    federationInstallments: item.federationData.installments\r\n                }\r\n            });\r\n            count++;\r\n        }\r\n        await createAuditLog('IMPORT_FEDERATION_PAYMENTS', 'Player', 'BATCH', { count, total: updates.length });\r\n        return { success: true, message: `Se actualizÃ³ el pago de federaciÃ³n/seguro de ${count} jugadores correctamente.` };\r\n    } catch (error: any) {\r\n        return { success: false, message: \"Error al guardar: \" + error.message };\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;;MA+OsB,wBAAA,WAAA,GAAA,IAAA,+OAAA,EAAA,8CAAA,oOAAA,EAAA,KAAA,GAAA,0OAAA,EAAA,sDAAA"}},
    {"offset": {"line": 32, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/damia/My%20Drive/Consultorias/All%20Boys/gestion-basket-app/src/components/payment-importer.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { useState } from 'react';\r\nimport { processPaymentExcel, savePaymentUpdates, ImportResult } from '@/lib/payment-actions';\r\nimport { useRouter } from 'next/navigation';\r\n\r\nexport default function PaymentImporter() {\r\n    const [result, setResult] = useState<ImportResult | null>(null);\r\n    const [loading, setLoading] = useState(false);\r\n    const [saving, setSaving] = useState(false);\r\n    const [error, setError] = useState<string | null>(null);\r\n    const [successMessage, setSuccessMessage] = useState<string | null>(null);\r\n    const router = useRouter();\r\n\r\n    async function handleAnalyze(formData: FormData) {\r\n        setLoading(true);\r\n        setError(null);\r\n        setResult(null);\r\n        setSuccessMessage(null);\r\n\r\n        try {\r\n            const res = await processPaymentExcel(null, formData);\r\n            if (res.success) {\r\n                setResult(res);\r\n            } else {\r\n                setError(res.message || \"Error desconocido al procesar el archivo.\");\r\n                if (res.logs && res.logs.length > 0) {\r\n                    setResult(res);\r\n                }\r\n            }\r\n        } catch (err) {\r\n            setError(\"OcurriÃ³ un error inesperado.\");\r\n            console.error(err);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    }\r\n\r\n    async function handleConfirm() {\r\n        if (!result) return;\r\n        setSaving(true);\r\n        try {\r\n            const res = await savePaymentUpdates(null, result.results);\r\n            if (res.success) {\r\n                setSuccessMessage(res.message || \"Cambios guardados correctamente.\");\r\n                setResult(null); // Clear analysis to prevent re-submit\r\n                // Refresh data\r\n                router.refresh();\r\n            } else {\r\n                setError(res.message || \"Error al guardar los cambios.\");\r\n            }\r\n        } catch (err: any) {\r\n            setError(\"Error inesperado al guardar: \" + err.message);\r\n        } finally {\r\n            setSaving(false);\r\n        }\r\n    }\r\n\r\n    const handleRetry = () => {\r\n        setResult(null);\r\n        setError(null);\r\n        setSuccessMessage(null);\r\n    };\r\n\r\n    if (result) {\r\n        const unmatched = result.results.filter(r => r.status === 'UNMATCHED');\r\n        const matched = result.results.filter(r => r.status === 'MATCHED');\r\n\r\n        return (\r\n            <div className=\"space-y-8 pb-20\"> {/* pb-20 for sticky footer space */}\r\n                <div className=\"flex justify-between items-center flex-wrap gap-4\">\r\n                    <h2 className=\"text-2xl font-bold\">Resultados del AnÃ¡lisis</h2>\r\n                    <button onClick={handleRetry} className=\"btn btn-secondary\" disabled={saving}>\r\n                        ğŸ”„ Analizar otro archivo\r\n                    </button>\r\n                </div>\r\n\r\n                {/* KPI Cards */}\r\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n                    <div className=\"card p-4 text-center border-l-4 border-blue-500\">\r\n                        <div className=\"text-3xl font-bold\">{result.stats.total}</div>\r\n                        <div className=\"text-sm text-gray-500 font-medium tracking-wide\">TOTAL FILAS</div>\r\n                    </div>\r\n                    <div className=\"card p-4 text-center border-l-4 border-green-500 bg-green-50/50\">\r\n                        <div className=\"text-3xl font-bold text-green-700\">{result.stats.matched}</div>\r\n                        <div className=\"text-sm text-green-700 font-medium tracking-wide\">COINCIDENCIAS</div>\r\n                    </div>\r\n                    <div className={`card p-4 text-center border-l-4 ${result.stats.unmatched > 0 ? 'border-red-500 bg-red-50/50' : 'border-gray-200'}`}>\r\n                        <div className={`text-3xl font-bold ${result.stats.unmatched > 0 ? 'text-red-700' : 'text-gray-400'}`}>{result.stats.unmatched}</div>\r\n                        <div className={`text-sm font-medium tracking-wide ${result.stats.unmatched > 0 ? 'text-red-700' : 'text-gray-500'}`}>NO ENCONTRADOS</div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* UNMATCHED SECTION - Priority */}\r\n                {unmatched.length > 0 && (\r\n                    <div className=\"card border-red-200 overflow-hidden\">\r\n                        <div className=\"bg-red-50 p-4 border-b border-red-100 flex justify-between items-center\">\r\n                            <h3 className=\"font-bold text-red-800 flex items-center gap-2\">\r\n                                âš ï¸ Requieren AtenciÃ³n ({unmatched.length})\r\n                            </h3>\r\n                            <span className=\"text-xs text-red-600 bg-red-100 px-2 py-1 rounded\">\r\n                                No se actualizarÃ¡n\r\n                            </span>\r\n                        </div>\r\n                        <div className=\"max-h-96 overflow-y-auto\">\r\n                            <table className=\"w-full text-sm text-left\">\r\n                                <thead className=\"bg-red-50/50 text-xs font-bold text-red-700 uppercase sticky top-0\">\r\n                                    <tr>\r\n                                        <th className=\"p-3\">DNI Excel</th>\r\n                                        <th className=\"p-3\">Nombre Excel</th>\r\n                                        <th className=\"p-3\">Motivo / Notas</th>\r\n                                    </tr>\r\n                                </thead>\r\n                                <tbody className=\"divide-y divide-red-100\">\r\n                                    {unmatched.map((item, idx) => (\r\n                                        <tr key={idx} className=\"hover:bg-red-50/30\">\r\n                                            <td className=\"p-3 font-mono\">{item.originalData['DNI'] || '-'}</td>\r\n                                            <td className=\"p-3\">{item.originalData['Apellido']} {item.originalData['Nombre']}</td>\r\n                                            <td className=\"p-3 text-red-600 text-xs\">\r\n                                                {item.notes?.join(', ') || 'Sin coincidencia'}\r\n                                            </td>\r\n                                        </tr>\r\n                                    ))}\r\n                                </tbody>\r\n                            </table>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n\r\n                {/* MATCHED SECTION - Collapsed by default if too many? No, just list them below */}\r\n                {matched.length > 0 && (\r\n                    <div className=\"card overflow-hidden\">\r\n                        <div className=\"bg-green-50 p-4 border-b border-green-100 flex justify-between items-center\">\r\n                            <h3 className=\"font-bold text-green-800 flex items-center gap-2\">\r\n                                âœ… Listos para Importar ({matched.length})\r\n                            </h3>\r\n                            <span className=\"text-xs text-green-600 bg-green-100 px-2 py-1 rounded\">\r\n                                Se actualizarÃ¡n sus pagos\r\n                            </span>\r\n                        </div>\r\n                        <div className=\"max-h-[500px] overflow-y-auto\">\r\n                            <table className=\"w-full text-sm text-left\">\r\n                                <thead className=\"bg-gray-50 text-xs font-bold text-gray-700 uppercase sticky top-0\">\r\n                                    <tr>\r\n                                        <th className=\"p-3\">Jugador (DB)</th>\r\n                                        <th className=\"p-3\">MÃ©todo</th>\r\n                                        <th className=\"p-3 text-center\">Ãšlt. Social</th>\r\n                                        <th className=\"p-3 text-center\">Ãšlt. Actividad</th>\r\n                                    </tr>\r\n                                </thead>\r\n                                <tbody className=\"divide-y divide-gray-100\">\r\n                                    {matched.map((item, idx) => (\r\n                                        <tr key={idx} className=\"hover:bg-gray-50\">\r\n                                            <td className=\"p-3\">\r\n                                                <div className=\"font-medium text-gray-900\">{item.player?.name}</div>\r\n                                                <div className=\"text-xs text-gray-500\">{item.player?.category}</div>\r\n                                            </td>\r\n                                            <td className=\"p-3\">\r\n                                                <span className=\"text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full border border-gray-200\">\r\n                                                    {item.matchMethod}\r\n                                                </span>\r\n                                            </td>\r\n                                            <td className=\"p-3 text-center\">\r\n                                                <PaymentBadge value={item.paymentStatus?.social} />\r\n                                            </td>\r\n                                            <td className=\"p-3 text-center\">\r\n                                                <PaymentBadge value={item.paymentStatus?.activity} />\r\n                                            </td>\r\n                                        </tr>\r\n                                    ))}\r\n                                </tbody>\r\n                            </table>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n\r\n                {/* Sticky Footer for Action */}\r\n                <div className=\"fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 shadow-lg z-50 flex justify-end items-center gap-4 md:pr-12\">\r\n                    <div className=\"text-sm text-gray-600 hidden md:block\">\r\n                        Se actualizarÃ¡n <strong>{matched.length}</strong> jugadores.\r\n                    </div>\r\n                    <button onClick={handleRetry} className=\"btn btn-secondary\" disabled={saving}>\r\n                        Cancelar\r\n                    </button>\r\n                    <button\r\n                        onClick={handleConfirm}\r\n                        className=\"btn btn-primary shadow-md hover:shadow-lg transform active:scale-95 transition-all\"\r\n                        disabled={saving || matched.length === 0}\r\n                    >\r\n                        {saving ? (\r\n                            <span className=\"flex items-center gap-2\">\r\n                                <span className=\"animate-spin text-lg\">â³</span> Guardando...\r\n                            </span>\r\n                        ) : (\r\n                            <span className=\"flex items-center gap-2\">\r\n                                âœ… Confirmar e Impactar\r\n                            </span>\r\n                        )}\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"card max-w-2xl mx-auto mt-8 relative\">\r\n            <h2 className=\"text-xl font-bold mb-4\">Importar Reporte de Pagos</h2>\r\n\r\n            {/* Instructions Accordion */}\r\n            <details className=\"mb-6 bg-blue-50 rounded-lg border border-blue-100 group\">\r\n                <summary className=\"cursor-pointer p-4 font-medium text-blue-800 flex justify-between items-center group-open:border-b group-open:border-blue-200\">\r\n                    <span>â„¹ï¸ Instrucciones y Formato de Archivo</span>\r\n                    <span className=\"text-blue-500 group-open:rotate-180 transition-transform\">â–¼</span>\r\n                </summary>\r\n                <div className=\"p-4 text-sm text-blue-900 space-y-2\">\r\n                    <p>El sistema busca automÃ¡ticamente una hoja llamada <strong>\"Basquet\"</strong>.</p>\r\n                    <p>Las columnas esperadas son:</p>\r\n                    <ul className=\"list-disc pl-5 space-y-1\">\r\n                        <li><strong>DNI</strong>: Para buscar coincidencia exacta.</li>\r\n                        <li><strong>Nro. Socio</strong>: Alternativa si no hay DNI.</li>\r\n                        <li><strong>Apellido / Nombre</strong>: Ãšltima opciÃ³n de bÃºsqueda (Fuzzy Match).</li>\r\n                        <li><strong>Ultima cuota Social Abonada</strong>: Formato YYYYMM (ej: 202601).</li>\r\n                        <li><strong>Ultima cuota Actividad Abonada</strong>: Formato YYYYMM.</li>\r\n                    </ul>\r\n                </div>\r\n            </details>\r\n\r\n            {successMessage && (\r\n                <div className=\"p-4 mb-6 text-sm text-green-800 rounded-lg bg-green-50 border border-green-200 shadow-sm animate-fade-in\">\r\n                    <div className=\"flex justify-between items-start\">\r\n                        <div>\r\n                            <span className=\"font-bold text-lg block mb-1\">âœ… OperaciÃ³n Exitosa</span>\r\n                            <p>{successMessage}</p>\r\n                        </div>\r\n                        <button onClick={() => setSuccessMessage(null)} className=\"text-green-600 hover:text-green-800\">\r\n                            âœ•\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            <form action={handleAnalyze}>\r\n                <div className=\"mb-6\">\r\n                    <label className=\"block mb-2 text-sm font-medium text-gray-900\">Seleccionar Archivo Excel (.xlsx)</label>\r\n                    <div className=\"flex items-center justify-center w-full\">\r\n                        <label className=\"flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors\">\r\n                            <div className=\"flex flex-col items-center justify-center pt-5 pb-6\">\r\n                                <svg className=\"w-8 h-8 mb-4 text-gray-500\" aria-hidden=\"true\" xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 20 16\" width=\"32\" height=\"32\">\r\n                                    <path stroke=\"currentColor\" strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth=\"2\" d=\"M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2\" />\r\n                                </svg>\r\n                                <p className=\"mb-2 text-sm text-gray-500\"><span className=\"font-semibold\">Click para subir</span> o arrastrar y soltar</p>\r\n                                <p className=\"text-xs text-gray-500\">XLSX o XLS</p>\r\n                            </div>\r\n                            <input type=\"file\" name=\"file\" accept=\".xlsx, .xls\" required className=\"hidden\" />\r\n                        </label>\r\n                    </div>\r\n                </div>\r\n\r\n                {error && (\r\n                    <div className=\"p-4 mb-4 text-sm text-red-800 rounded-lg bg-red-50 border border-red-200\" role=\"alert\">\r\n                        <span className=\"font-bold block mb-1\">Error</span>\r\n                        {error}\r\n                    </div>\r\n                )}\r\n\r\n                <button\r\n                    type=\"submit\"\r\n                    disabled={loading}\r\n                    className=\"w-full btn btn-primary flex justify-center items-center gap-2 py-3 text-lg font-medium shadow-md transition-all hover:translate-y-[-1px]\"\r\n                >\r\n                    {loading ? (\r\n                        <>âš™ï¸ Analizando...</>\r\n                    ) : (\r\n                        <>ğŸ” Analizar Archivo</>\r\n                    )}\r\n                </button>\r\n            </form>\r\n        </div>\r\n    );\r\n}\r\n\r\nfunction PaymentBadge({ value }: { value?: string }) {\r\n    if (!value || value === '-') return <span className=\"text-gray-300 text-xs\">-</span>;\r\n    // Assuming YYYYMM format like 202601\r\n    const isCurrent = parseInt(value) >= 202601; // Example logic, logic can be improved\r\n\r\n    // Check if it looks like a month/year\r\n    if (value.length === 6 && !isNaN(parseInt(value))) {\r\n        const year = value.substring(0, 4);\r\n        const month = value.substring(4, 6);\r\n        return (\r\n            <span className={`inline-flex items-center px-2 py-0.5 rounded-md text-xs font-bold border ${isCurrent ? 'bg-green-100 text-green-700 border-green-200' : 'bg-yellow-50 text-yellow-700 border-yellow-200'}`}>\r\n                {month}/{year}\r\n            </span>\r\n        );\r\n    }\r\n\r\n    return <span className=\"text-sm font-medium\">{value}</span>;\r\n}\r\n"],"names":[],"mappings":"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"}}]
}